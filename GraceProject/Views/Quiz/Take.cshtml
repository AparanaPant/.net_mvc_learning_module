@model GraceProject.ViewModels.QuizViewModel
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery

@{
    ViewData["Title"] = "Take Quiz";
    Layout = "~/Views/Shared/_StudentLayout.cshtml";
    var tokens = Antiforgery.GetAndStoreTokens(Context);
}

<style>
    .form-check-label {
        margin-left: 30px;
    }

    .time-details {
        background-color: #f8f9fa;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        width: 200px;
        text-align: center;
        margin-bottom: 20px;
    }

    .question-card {
        margin-bottom: 20px;
    }

    .card-header {
        background-color: #ffffff;
        color: black;
        border-bottom: 1px solid #ddd;
    }

    .card-body {
        background-color: #f8f9fa;
    }

    .btn {
        margin: 5px;
    }

    .navigation-buttons {
        text-align: center;
    }

    .submit-button {
        text-align: center;
    }

    .quiz-container {
        flex-grow: 1;
        margin-right: 20px;
    }

    .question-navigation {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
    }

        .question-navigation button {
            margin: 2px;
        }
</style>

<div class="container mt-4">
    <form asp-action="Submit" asp-controller="Quiz" method="post">
        @Html.AntiForgeryToken()
        <!-- Hidden QuizId to ensure it gets submitted -->
       <input type="hidden" id="RequestVerificationToken" name="__RequestVerificationToken" value="@tokens.RequestToken" />

        <input type="hidden" name="QuizId" value="@Model.QuizId"/>

        <h2 class="text-center mb-4">@Model.Title</h2>

        <div class="d-flex justify-content-between align-items-start">
            <div id="quiz-container" class="quiz-container">
                @for (int i = 0; i < Model.Questions.Count; i++)
                {
                    var question = Model.Questions[i];
                    <div class="question" id="question-@i" style="display: @(i == 0 ? "block" : "none")">
                        <div class="card question-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Question @(i + 1)</h5>
                                <span class="badge bg-secondary">
                                @question.Points pts
                                @if (Model.GameLevelID != null)
                                {
                                    <text> 💰</text> <!-- or use $$, or any icon of your choice -->
                                }
                            </span>
                            </div>
                            <div class="card-body">
                                <p class="card-text">@question.Text</p>

                                @if (!string.IsNullOrEmpty(question.ImageUrl))
                                {
                                    <div class="text-center mb-3">
                                        <img src="@question.ImageUrl" alt="Question Image" class="img-fluid mb-2" style="max-width: 100%; height: auto; max-height: 300px;" />
                                    </div>
                                }

                                <!-- Hidden QuestionId to be submitted -->
                                <input type="hidden" name="QuestionAnswers[@i].QuestionId" value="@question.QuestionId" />

                                <div class="mt-3">
                                    @if (question.Type == "Multiple Choice")
                                    {
                                        <div class="form-check mt-2 pt-2 border-top border-bottom">
                                            @for (int j = 0; j < question.Options.Count; j++)
                                            {
                                                var option = question.Options[j];
                                                <div class="form-check mt-2 pb-2 border-bottom">
                                                    <input class="form-check-input" type="radio" id="option-@i-@j" name="QuestionAnswers[@i].SelectedOptionId" value="@option.OptionId" />
                                                    <label class="form-check-label" for="option-@i-@j">@option.Text</label>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else if (question.Type == "Fill in the Blank")
                                    {
                                        <input class="form-control mt-2" type="text" name="QuestionAnswers[@i].FillInTheBlankResponse" placeholder="Fill in the blank" />
                                    }
                                    else if (question.Type == "True/False")
                                    {
                                        var trueOption = question.Options.FirstOrDefault(o => o.Text.Equals("True", StringComparison.OrdinalIgnoreCase));
                                        var falseOption = question.Options.FirstOrDefault(o => o.Text.Equals("False", StringComparison.OrdinalIgnoreCase));

                                        if (trueOption != null && falseOption != null)
                                        {
                                            <div class="form-check mt-2 pt-2 border-top border-bottom">
                                                <div class="form-check mt-2 pb-2 border-bottom">
                                                    <input class="form-check-input" type="radio" id="true-@i" name="QuestionAnswers[@i].SelectedOptionId" value="@trueOption.OptionId" />
                                                    <label class="form-check-label" for="true-@i">True</label>
                                                </div>
                                                <div class="form-check mt-2 pb-2 border-bottom">
                                                    <input class="form-check-input" type="radio" id="false-@i" name="QuestionAnswers[@i].SelectedOptionId" value="@falseOption.OptionId" />
                                                    <label class="form-check-label" for="false-@i">False</label>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <p class="text-danger">Error: True/False options are missing for this question.</p>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
            <div class="time-details">
                <h5>Time Details</h5>
                <p>Total Time: @Model.Duration minutes</p>
                <p id="time-elapsed">Time Elapsed: 0 Minutes, 0 Seconds</p>
            </div>
        </div>

        <div class="navigation-buttons mt-4">
            <button id="prev-button" class="btn btn-secondary" type="button" onclick="navigateQuestions(-1)" style="display:none;">Previous</button>
            <button id="next-button" class="btn btn-secondary" type="button" onclick="navigateQuestions(1)">Next</button>
        </div>
        <div class="submit-button mt-3">
            <button id="submit-button" type="submit" class="btn btn-primary" style="display:none;">Submit</button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        let currentQuestionIndex = 0;
        const totalQuestions = @Model.Questions.Count;

        let totalTimeInSeconds = @Model.Duration * 60; // Duration is in minutes
        let remainingSeconds = totalTimeInSeconds;
        let timerInterval;
        let reminderShown = false;

        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hrs}h ${mins}m ${secs.toFixed(0)}s`;
        }

        function updateTimerDisplay() {
            document.getElementById("time-elapsed").textContent = `Time Left: ${formatTime(remainingSeconds)}`;
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                remainingSeconds--;

                updateTimerDisplay();

                if (!reminderShown && remainingSeconds === 180) {
                    alert("⏳ Reminder: Only 3 minutes remaining!");
                    reminderShown = true;
                }

                if (remainingSeconds <= 0) {
                    clearInterval(timerInterval);
                    showFinalCountdown();
                }
            }, 1000);
        }

          function showFinalCountdown() {
            let counter = 5;
            const overlay = document.createElement("div");
            overlay.style.position = "fixed";
            overlay.style.top = 0;
            overlay.style.left = 0;
            overlay.style.width = "100%";
            overlay.style.height = "100%";
            overlay.style.backgroundColor = "rgba(0,0,0,0.7)";
            overlay.style.display = "flex";
            overlay.style.justifyContent = "center";
            overlay.style.alignItems = "center";
            overlay.style.color = "#fff";
            overlay.style.fontSize = "2rem";
            overlay.style.zIndex = 9999;
            overlay.innerHTML = `⏱ Time's up! Submitting in <span id="final-countdown">${counter}</span> seconds...`;
            document.body.appendChild(overlay);

            const finalInterval = setInterval(() => {
                counter--;
                document.getElementById("final-countdown").textContent = counter;

                if (counter <= 0) {
                    clearInterval(finalInterval);
                    overlay.remove();
                    document.querySelector("form").submit(); // 🔥 Native form submit
                }
            }, 1000);
        }

           function submitQuizAjax() {
            const form = document.querySelector("form");
            const formData = new FormData(form);

            // Get anti-forgery token by name, not id
            const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            if (tokenInput) {
                formData.append("__RequestVerificationToken", tokenInput.value);
            }

            fetch('/Quiz/Submit', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': tokenInput?.value
                }
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    return response.text().then(html => {
                        document.open();
                        document.write(html);
                        document.close();
                    });
                }
            })
            .catch(err => {
                alert("❌ Failed to auto-submit quiz. Please try again.");
                console.error(err);
            });
        }

        function navigateQuestions(direction) {
            document.getElementById(`question-${currentQuestionIndex}`).style.display = "none";
            currentQuestionIndex += direction;
            currentQuestionIndex = Math.max(0, Math.min(currentQuestionIndex, totalQuestions - 1));
            document.getElementById(`question-${currentQuestionIndex}`).style.display = "block";

            document.getElementById('prev-button').style.display = currentQuestionIndex === 0 ? "none" : "inline-block";
            document.getElementById('next-button').style.display = currentQuestionIndex === totalQuestions - 1 ? "none" : "inline-block";
            document.getElementById('submit-button').style.display = currentQuestionIndex === totalQuestions - 1 ? "inline-block" : "none";
        }

        window.onload = function () {
            document.getElementById('prev-button').style.display = "none";
            document.getElementById('next-button').style.display = totalQuestions > 1 ? "inline-block" : "none";
            document.getElementById('submit-button').style.display = totalQuestions === 1 ? "inline-block" : "none";
            updateTimerDisplay();
            startTimer(); //Start the countdown
        };

                  setInterval(() => {
            fetch('/Quiz/KeepAlive');
        }, 20000); // 20 seconds

    </script>
}
