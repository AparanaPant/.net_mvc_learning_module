@model GraceProject.Models.Report

@{
    ViewData["Title"] = "Admin Report";
    Layout = "~/Views/Shared/_StudentLayout.cshtml";
}

<!-- Bootstrap Container -->
<div class="container mt-5">
    <h2 class="mb-4 text-center">Admin Report</h2>

    <!-- Search Form -->
    <div class="row mb-4">
        <!-- Search Type -->
        <div class="col-md-3">
            <label for="searchType" class="form-label">Search By</label>
            <select id="searchType" class="form-control">
                <option value="student">Student Name</option>
                <option value="course">Course Name</option>
            </select>
        </div>

        <!-- Search Value -->
        <div class="col-md-3">
            <label for="searchValue" class="form-label">Value</label>
            <input type="text" id="searchValue" class="form-control" placeholder="Type to search..." />
            <input type="hidden" id="selectedId">
        </div>

        <!-- Dynamic Dropdown for Sessions -->
        <div class="col-md-3">
            <label for="dynamicDropdown" class="form-label">Select Session</label>
            <select id="dynamicDropdown" class="form-control">
                <option value="">Please select</option>
            </select>
        </div>

        <!-- Search Button -->
        <div class="col-md-3">
            <br />
            <button id="searchBtn" class="btn btn-primary w-100">Search</button>
        </div>
    </div>

    <!-- Placeholder for Results -->
    <div id="results" class="mt-5">
        <h5>Search Results:</h5>
        <pre id="resultsContent">No results yet.</pre>
    </div>
</div>

<!-- Load jQuery, jQuery UI, and Bootstrap Select -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

<!-- JavaScript for Autocomplete and AJAX -->
<script>
    $(document).ready(function () {
        console.log("Document Ready!");

        // Initial setup
        setupAutocomplete();

        // Handle search type change
        $('#searchType').change(function () {
            console.log("Search Type Changed: " + $(this).val());
            $('#searchValue').val('');
            $('#dynamicDropdown').empty().append('<option value="">Please select</option>');
            setupAutocomplete();
        });

        // Setup autocomplete based on search type
               function setupAutocomplete() {
        let searchType = $('#searchType').val();
        let url = searchType === 'student' ? '/Report/Report/GetStudentList' : '/Report/Report/GetCourseList';

        $('#searchValue').autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: url,
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    data: JSON.stringify({ keyword: request.term }),
                    success: function (data) {
                        response($.map(data, function (item) {
                            // Show name without email in brackets for cleaner UI
                            return {
                                label: item.name,  // Only show name (no email)
                                value: item.id
                            };
                        }));
                    },
                    error: function (xhr, status, error) {
                        console.log("AJAX Error:", error);
                        console.log("Status:", status);
                        console.log("Response:", xhr.responseText);
                    }
                });
            },
            select: function (event, ui) {
                $('#searchValue').val(ui.item.label);
                $('#selectedId').val(ui.item.value);
                loadSessions(ui.item.value);
                return false;
            }
        });
    }

        // Load sessions for selected student or course
           function loadSessions(selectedId) {
        let searchType = $('#searchType').val();
        let url = searchType === 'student' ? '/Report/Report/GetSessionsByStudent' : '/Report/Report/GetSessionsByCourse';

        $.ajax({
            url: url,
            type: 'POST',
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            data: JSON.stringify({ id: selectedId }),
            success: function (data) {
                console.log("Sessions received:", data);
                $('#dynamicDropdown').empty().append('<option value="">Please select</option>');

                // Populate the dropdown based on search type
                $.each(data, function (index, item) {
                    let optionText = searchType === 'student'
                        ? `${item.name}`  // Show "Course Name - Instructor Name" for students
                        : `${item.name}`;  // Show "Instructor Name" for courses

                    $('#dynamicDropdown').append('<option value="' + item.id + '">' + optionText + '</option>');
                });
            },
            error: function (xhr, status, error) {
                console.error("Failed to load sessions:", error);
            }
        });
    }


        // Trigger search button
        $('#searchBtn').click(function () {
            let selectedSession = $('#dynamicDropdown').val();
            if (selectedSession) {
                $('#resultsContent').text('Report for Session ID: ' + selectedSession);
            } else {
                $('#resultsContent').text('Please select a session.');
            }
        });
    });
</script>
