@model GraceProject.Models.Report

@{
    ViewData["Title"] = "Admin Report";
    Layout = "~/Views/Shared/_StudentLayout.cshtml";
}

<div class="container mt-5">
    <h2 class="mb-4 text-center">Admin Report</h2>

    <!-- Search Form -->
    <div class="row mb-4">
        <!-- Search Type -->
        <!-- Search Type -->
        <div class="col-md-3">
            <label for="searchType" class="form-label">Search By</label>
            <select id="searchType" class="form-control">
                <option value="student">Student Name</option>
                <option value="course">Course Name</option>
                <option value="educator">Educator Name</option>
                <option value="school">School Name</option>  <!-- New Option -->
            </select>
        </div>

        <!-- Search Value -->
        <div class="col-md-3">
            <label for="searchValue" class="form-label">Value</label>
            <input type="text" id="searchValue" class="form-control" placeholder="Type to search..." />
            <input type="hidden" id="selectedId">
        </div>

        <!-- Search For Dropdown -->
        <div class="col-md-3">
            <label for="searchFor" class="form-label">Search For</label>
            <select id="searchFor" class="form-control">
                <option value="">Please select</option>
            </select>
        </div>

        <!-- Dynamic Dropdown for Courses or Sessions -->
        <div class="col-md-3">
            <label id="dynamicDropdownLabel" for="dynamicDropdown" class="form-label">Select Session</label>
            <select id="dynamicDropdown" class="form-control">
                <option value="">Please select</option>
            </select>
        </div>

        <!-- Date Range Selection -->
        <div class="col-md-3">
            <label for="dateFilterType" class="form-label">Date Filter</label>
            <select id="dateFilterType" class="form-control">
                <option value="last3months" selected>Last 3 Months</option>
                <option value="monthly">Monthly</option>
                <option value="weekly">Weekly</option>
                <option value="custom">Custom</option>
            </select>
        </div>

        <!-- Custom Date Picker (Initially Hidden) -->
        <div class="col-md-3 custom-date-range d-none">
            <label for="startDate" class="form-label">Start Date</label>
            <input type="date" id="startDate" class="form-control">
        </div>

        <div class="col-md-3 custom-date-range d-none">
            <label for="endDate" class="form-label">End Date</label>
            <input type="date" id="endDate" class="form-control">
        </div>

        <!-- Search Button -->
        <div class="col-md-3 mt-2">
            <button id="searchBtn" class="btn btn-primary w-100">Search</button>
        </div>
    </div>

    <!-- Placeholder for Results -->
    <div id="results" class="mt-5">
        <h5>Search Results:</h5>
        <pre id="resultsContent">No results yet.</pre>
    </div>
</div>

<!-- Load jQuery, jQuery UI, and Bootstrap Select -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

<script>
    $(document).ready(function () {
        console.log("Document Ready!");

        // Initial setup
        setupAutocomplete();
        setupSearchForOptions();

        // Show/Hide Custom Date Picker
        $('#dateFilterType').change(function () {
            if ($(this).val() === 'custom') {
                $('.custom-date-range').removeClass('d-none');
            } else {
                $('.custom-date-range').addClass('d-none');
            }
        });


        // Handle search type change
        $('#searchType').change(function () {
            console.log("Search Type Changed: " + $(this).val());
            $('#searchValue').val('');
            $('#dynamicDropdown').empty().append('<option value="">Please select</option>');
            setupAutocomplete();
            setupSearchForOptions();
        });

                    function setupSearchForOptions() {
                    let searchType = $('#searchType').val();
                    let searchForDropdown = $('#searchFor');
                    searchForDropdown.empty();

                    if (searchType === 'student') {
                        searchForDropdown.append(new Option("Grades", "grades"));
                        searchForDropdown.append(new Option("Time Spent on Slides", "timeSpent"));
                        searchForDropdown.append(new Option("Number of Slides Viewed", "slidesViewed"));
                    } else if (searchType === 'course' || searchType === 'educator') {
                        searchForDropdown.append(new Option("Grades", "grades"));
                    } else if (searchType === 'school') {  // New condition for School
                        searchForDropdown.append(new Option("Grades", "grades"));
                        searchForDropdown.append(new Option("Time Spent on Slides", "timeSpent"));
                        searchForDropdown.append(new Option("Number of Slides Viewed", "slidesViewed"));
                    } else {
                        searchForDropdown.append(new Option("Please select", ""));
                    }
                }


                // Setup autocomplete based on search type
                    function setupAutocomplete() {
        let searchType = $('#searchType').val();
        let dynamicDropdownLabel = $("#dynamicDropdownLabel");
        let dynamicDropdown = $('#dynamicDropdown');

        // Handle dropdown behavior based on search type
        if (searchType === 'school') {
            $('#dynamicDropdown').prop('disabled', true).empty().append('<option value="">Please select</option>');
        } else {
            $('#dynamicDropdown').prop('disabled', false); // Enable for other cases
        }

        let url = "";
        if (searchType === 'student') {
            url = '/Report/Report/GetStudentList';
            dynamicDropdownLabel.text("Select Course");  // Show Course dropdown
            loadCourses();  // Load courses for students
        } else if (searchType === 'course') {
            url = '/Report/Report/GetCourseList';
            dynamicDropdownLabel.text("Select Session");  // Show Session dropdown
        } else if (searchType === 'educator') {
            url = '/Report/Report/GetEducatorList';
            dynamicDropdownLabel.text("Select Course");  // Show Course dropdown
            loadCourses();  // Load courses for educators
        } else if (searchType === 'school') {
            url = '/Report/Report/GetSchoolList';
            dynamicDropdownLabel.text("Select Session");  // No course selection for schools
        }

        // Setup jQuery Autocomplete
        $('#searchValue').autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: url,
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    data: JSON.stringify({ keyword: request.term }),
                    success: function (data) {
                        response($.map(data, function (item) {
                            let labelText = searchType === 'student'
                                ? `${item.name} (${item.email})`
                                : item.name;

                            return {
                                label: labelText,
                                value: item.id
                            };
                        }));
                    },
                    error: function (xhr, status, error) {
                        console.log("AJAX Error:", error);
                    }
                });
            },
            select: function (event, ui) {
                $('#searchValue').val(ui.item.label);
                $('#selectedId').val(ui.item.value);

                // Load courses instead of sessions for Student & Educator
                if (searchType === 'student' || searchType === 'educator') {
                    loadCourses();
                } else if (searchType !== 'school') {
                    loadSessions(ui.item.value);
                }

                return false;
            }
        });
    }

        function loadCourses() {
        $.ajax({
            url: '/Report/Report/GetCourseList', // Fetch courses
            type: 'POST',
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            data: JSON.stringify({ keyword: "" }), // Fetch all courses
            success: function (data) {
                $('#dynamicDropdown').empty().append('<option value="">Please select</option>');
                $.each(data, function (index, item) {
                    $('#dynamicDropdown').append(new Option(item.name, item.id));
                });
            },
            error: function (xhr, status, error) {
                console.error("Failed to load courses:", error);
            }
        });
    }

        // Load sessions based on selected type
        function loadSessions(selectedId) {
            let searchType = $('#searchType').val();
            let url = searchType === 'student' ? '/Report/Report/GetSessionsByStudent' :
                      searchType === 'course' ? '/Report/Report/GetSessionsByCourse' :
                      '/Report/Report/GetSessionsByEducator';

            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                data: JSON.stringify({ id: selectedId }),
                success: function (data) {
                    $('#dynamicDropdown').empty().append('<option value="">Please select</option>');
                    $.each(data, function (index, item) {
                        $('#dynamicDropdown').append(new Option(item.name, item.id));
                    });
                },
                error: function (xhr, status, error) {
                    console.error("Failed to load sessions:", error);
                }
            });
        }

        // Handle Search Button Click
            $('#searchBtn').off('click').on('click', function () {
        console.log("Search Button Clicked");

        let selectedDropdownValue = $('#dynamicDropdown').val(); // Could be CourseID or SessionID
        let searchType = $('#searchType').val();
        let searchFor = $('#searchFor').val();
        let selectedId = $('#selectedId').val();
        let dateFilter = $('#dateFilterType').val();
        let startDate = $('#startDate').val();
        let endDate = $('#endDate').val();

        console.log(`SearchType: ${searchType}, SearchFor: ${searchFor}, SelectedID: ${selectedId}, SelectedDropdownValue: ${selectedDropdownValue}`);

        if (!selectedId) {
            $('#resultsContent').text('Please select a valid value from the dropdown.');
            return;
        }
            if (searchType === 'student' && searchFor === 'grades' && selectedDropdownValue) {
                fetchGrades(selectedId, selectedDropdownValue, dateFilter, startDate, endDate);
            } else if (searchType === 'educator' && searchFor === 'grades' && selectedDropdownValue) {
                fetchEducatorCourseGrades(selectedId, selectedDropdownValue, dateFilter, startDate, endDate);
            } else if (searchType === 'course' && searchFor === 'grades' && selectedDropdownValue) {
                fetchCourseGrades(selectedDropdownValue, dateFilter, startDate, endDate);
            } else if (searchType === 'school' && searchFor === 'grades') {
                fetchSchoolGrades(selectedId, dateFilter, startDate, endDate);
            } else {
                $('#resultsContent').text('Please select a valid search option.');
            }
    });


        function fetchSchoolGrades(schoolId, dateFilter, startDate, endDate) {
        $.ajax({
            url: '/Report/Report/GetSchoolGrades',
            type: 'POST',
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            data: JSON.stringify({
                Id: schoolId,
                DateFilter: dateFilter,
                StartDate: dateFilter === 'custom' ? startDate : null,
                EndDate: dateFilter === 'custom' ? endDate : null
            }),
            success: function (data) {
                let resultsContent = $('#resultsContent');
                resultsContent.empty(); // Clear previous results

                console.log("✅ School Grades received:", data); // Debugging

                // Check if courses exist in the response
                if (data && data.courses && data.courses.length > 0) {
                    let content = "";

                    data.courses.forEach(function (course) {
                        content += `<h4 class="mt-3">${course.courseTitle}</h4>`;
                        content += `<table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Quiz Title</th>
                                    <th>Score</th>
                                    <th>Full Marks</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>`;

                        course.students.forEach(function (student) {
                            if (student.quizzes.length > 0) {
                                student.quizzes.forEach(function (quiz, index) {
                                    content += `<tr>
                                        ${index === 0 ? `<td rowspan="${student.quizzes.length}">${student.studentName}</td>` : ""}
                                        <td>${quiz.quizTitle}</td>
                                        <td>${quiz.score}</td>
                                        <td>${quiz.fullMarks}</td>
                                        <td>${(quiz.fullMarks > 0) ? ((quiz.score / quiz.fullMarks) * 100).toFixed(2) + "%" : "N/A"}</td>
                                    </tr>`;
                                });
                            } else {
                                content += `<tr>
                                    <td>${student.studentName}</td>
                                    <td colspan="4" class="text-center">No quizzes available</td>
                                </tr>`;
                            }
                        });

                        content += `</tbody></table>`;
                    });

                    resultsContent.html(content);
                } else {
                    console.warn("⚠️ No grades found in response:", data);
                    resultsContent.html("<div class='alert alert-warning'>No grades available for this school.</div>");
                }
            },
            error: function (xhr, status, error) {
                console.error("❌ Failed to fetch school grades:", error);
                $('#resultsContent').html("<div class='alert alert-danger'>Failed to load grades. Please try again.</div>");
            }
        });
    }

        function fetchEducatorCourseGrades(educatorId, courseId, dateFilter, startDate, endDate) {
        $.ajax({
            url: '/Report/Report/GetEducatorCourseGrades',
            type: 'POST',
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            data: JSON.stringify({
                EducatorID: educatorId,
                CourseID: courseId,
                DateFilter: dateFilter,  // Include date filter
                StartDate: dateFilter === 'custom' ? startDate : null,
                EndDate: dateFilter === 'custom' ? endDate : null
            }),
            success: function (data) {
                let resultsContent = $('#resultsContent');
                resultsContent.empty(); // Clear previous results

                console.log("✅ Grades received:", data); // Debugging

                // Check if students exist in response
                if (data && data.students && data.students.length > 0) {
                    let gradeTable = `<table class="table table-bordered">
                        <thead>
                            <tr><th>Student Name</th><th>Quiz Title</th><th>Score</th><th>Full Marks</th><th>Date</th></tr>
                        </thead>
                        <tbody>`;

                    data.students.forEach(function (student) {
                        student.quizzes.forEach(function (quiz) {
                            gradeTable += `<tr>
                                <td>${student.studentName}</td>
                                <td>${quiz.quizTitle}</td>
                                <td>${quiz.obtainedScore}</td>
                                <td>${quiz.totalScore}</td>
                                <td>${quiz.date}</td>  <!-- Added Date Column -->
                            </tr>`;
                        });
                    });

                    gradeTable += `</tbody></table>`;
                    resultsContent.html(gradeTable);
                } else {
                    console.warn("⚠️ No grades found in response:", data);
                    resultsContent.html("<div class='alert alert-warning'>No grades available for this course.</div>");
                }
            },
            error: function (xhr, status, error) {
                console.error("❌ Failed to fetch educator's course grades:", error);
                $('#resultsContent').html("<div class='alert alert-danger'>Failed to load grades. Please try again.</div>");
            }
        });
    }

            // Fetch Grades Function
        function fetchGrades(studentId, courseId, dateFilter, startDate, endDate) {
        $.ajax({
            url: '/Report/Report/GetStudentGrades',
            type: 'POST',
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            data: JSON.stringify({
                CourseID: courseId,
                Keyword: studentId,
                DateFilter: dateFilter,  // New filter for weekly/monthly/custom
                StartDate: dateFilter === 'custom' ? startDate : null,
                EndDate: dateFilter === 'custom' ? endDate : null
            }),
            success: function (data) {
                let resultsContent = $('#resultsContent');
                resultsContent.empty();

                console.log("Grades received:", data);
                console.log("QuizResults:", data.quizResults);

                if (data && data.quizResults && data.quizResults.length > 0) {
                    let gradeTable = `<table class="table table-bordered">
                        <thead><tr><th>Quiz Title</th><th>Score</th><th>Full Marks</th><th>Date</th></tr></thead><tbody>`;

                    data.quizResults.forEach(function (quiz) {
                        gradeTable += `<tr>
                            <td>${quiz.quizTitle}</td>
                            <td>${quiz.score}</td>
                            <td>${quiz.fullMarks}</td>
                            <td>${quiz.date}</td>  <!-- Added Date Column -->
                        </tr>`;
                    });

                    gradeTable += `<tr class="font-weight-bold"><td>Total</td><td>${data.totalScore}</td><td>${data.totalFullMarks}</td><td></td></tr></tbody></table>`;
                    resultsContent.html(gradeTable);
                } else {
                    resultsContent.text("No grades available for this selection.");
                }
            },
            error: function (xhr, status, error) {
                console.error("Failed to fetch grades:", error);
            }
        });
    }


           function fetchCourseGrades(sessionId, dateFilter, startDate, endDate) {
        $('#resultsContent').html("<div class='text-center'><span class='spinner-border'></span> Loading grades...</div>");

        $.ajax({
            url: '/Report/Report/GetCourseGrades',
            type: 'POST',
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            data: JSON.stringify({
                Id: sessionId,
                DateFilter: dateFilter,
                StartDate: dateFilter === 'custom' ? startDate : null,
                EndDate: dateFilter === 'custom' ? endDate : null
            }),
            success: function (data) {
                let resultsContent = $('#resultsContent');
                resultsContent.empty();

                if (data && data.students && data.students.length > 0) {
                    let gradeTable = `<table class="table table-bordered">
                        <thead>
                            <tr><th>Student Name</th><th>Quiz Title</th><th>Score</th><th>Full Marks</th></tr>
                        </thead><tbody>`;

                    data.students.forEach(function (student) {
                        student.quizzes.forEach(function (quiz) {
                            gradeTable += `<tr>
                                <td>${student.studentName}</td>
                                <td>${quiz.quizTitle}</td>
                                <td>${quiz.obtainedScore}</td>
                                <td>${quiz.totalScore}</td>
                            </tr>`;
                        });
                    });

                    gradeTable += `</tbody></table>`;
                    resultsContent.html(gradeTable);
                } else {
                    resultsContent.html("<div class='alert alert-warning'>No grades available for this session.</div>");
                }
            },
            error: function (xhr, status, error) {
                console.error("Failed to fetch grades:", error);
                $('#resultsContent').html("<div class='alert alert-danger'>Failed to load grades. Please try again later.</div>");
            }
        });
    }


    });
</script>
